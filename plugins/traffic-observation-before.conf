# ------------------------------------------------------------------------
# OWASP CRS Plugin
# Copyright (c) 2021-2025 CRS project. All rights reserved.
#
# The OWASP CRS plugins are distributed under
# Apache Software License (ASL) version 2
# Please see the enclosed LICENSE file for full details.
# ------------------------------------------------------------------------

# OWASP CRS Plugin
# Plugin name: traffic-observation-plugin
# Plugin description: This is an offical CRS plugin that logs information 
#                     about requests that is not normally logged.
# Rule ID block base: 9,526,000 (range is 1000, thus ID block base +1000)
# Plugin version: 1.0.0

# Generic rule to disable plugin
SecRule TX:traffic-observation-plugin_enabled "@eq 0" "id:9526099,phase:1,pass,nolog,ctl:ruleRemoveById=9526100-9526999"


#
# -=[ Sampling Percentage ]=-
#
# This is used to log only a limited percentage of requests,
# The selection is based on TX.traffic-observation-sampling-percentage.
#
# Also see the CRS REQUEST-901-INITIALIZATION.conf file for more information.
#

# Skip sampling when sampling percentage is not set
SecRule &TX:traffic-observation-sampling_percentage "@eq 0" \
    "id:9526100,\
    phase:1,\
    pass,\
    skipAfter:TRAFFIC-OBSERVATION-END-SAMPLING"

# Skip sampling when sampling percentage is 100
SecRule TX:traffic-observation-sampling_percentage "@streq 100" \
    "id:9526101,\
    phase:1,\
    pass,\
    skipAfter:TRAFFIC-OBSERVATION-END-SAMPLING"

# Skip sampling when sampling percentage is 100.0
SecRule TX:traffic-observation-sampling_percentage "@streq 100.0" \
    "id:9526102,\
    phase:1,\
    pass,\
    skipAfter:TRAFFIC-OBSERVATION-END-SAMPLING"

# Rewrite sampling percentage to promille (e.g. 15.2% -> 152â€°)
SecRule TX:traffic-observation-sampling_percentage "@rx ([0-9])([0-9])?\.?([0-9])?" \
    "id:9526103,\
    phase:1,\
    pass,\
    capture,\
    setvar:'tx.traffic-observation-mysampling_percentage=%{TX.1}%{TX.2}%{TX.3}'"

# Get random number (0 .. 999)
SecRule UNIQUE_ID "@rx ^[a-f]*([0-9])[a-f]*([0-9])[a-f]*([0-9])" \
    "id:9256104,\
    phase:1,\
    pass,\
    capture,\
    t:sha1,t:hexEncode,\
    setvar:'tx.traffic-observation-sampling_rnd1000=%{TX.1}%{TX.2}%{TX.3}'"

#
# Sampling decision
#

SecRule TX:traffic-observation-sampling_rnd1000 "!@lt %{tx.traffic-observation-mysampling_percentage}" \
    "id:901450,\
    phase:1,\
    pass,\
    ctl:ruleRemoveById=9526100-9526999"

SecMarker "TRAFFIC-OBSERVATION-END-SAMPLING"
